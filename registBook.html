<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>本の登録</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      defer
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
  </head>
  <body class="p-4">
    <h2>新しい本を登録</h2>
    <form id="addBookForm" style="max-width: 600px">
      <div class="mb-2">
        <label class="form-label">タイトル</label>
        <input type="text" id="title" class="form-control" required />
      </div>
      <div class="mb-2">
        <label class="form-label">著者</label>
        <input type="text" id="author" class="form-control" required />
      </div>
      <div class="mb-2">
        <label class="form-label">ISBN</label>
        <input type="text" id="isbn" class="form-control" required />
      </div>
      <button type="submit" class="btn btn-primary mt-2">登録</button>
    </form>

    <script>
      const apiUrl = "http://localhost:3000/books";

      document
        .getElementById("addBookForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // 入力値をまとめる
          const newBook = {
            title: document.getElementById("title").value,
            stars: 0,
            reviews: 0,
            author: document.getElementById("author").value,
            translator: "",
            isbn: document.getElementById("isbn").value,
            year: "2025",
            category: [1],
            description: "テスト用データ",
            image: "/images/noimage.png",
            library1: "1",
            library2: "0",
            library3: "0",
          };

          try {
            // 既存の books を取得して最大 id を求める
            const res = await fetch(apiUrl);
            const books = await res.json();
            books.forEach((b) => (b.id = Number(b.id))); // 既存idを全部数値に直す
            const maxId = Math.max(...books.map((b) => b.id), 0);
            newBook.id = maxId + 1;

            // 自前で id を割り振る
            newBook.id = maxId + 1;

            // POST
            const res2 = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(newBook),
            });
            const data = await res2.json();

            alert(`本を登録しました (id: ${data.id})`);
            console.log("登録結果:", data);
          } catch (err) {
            console.error("登録エラー:", err);
          }
        });
    </script>
  </body>
</html>
