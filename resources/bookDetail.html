<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>社内図書サービス</title>
    <!-- Bootstrap CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/resources/style.css" />
  </head>
  <body>
    <!-- ナビバー -->
    <nav class="navbar sticky-top">
      <div
        class="container d-flex flex-wrap justify-content-between align-items-center"
        style="max-width: 1200px; margin: auto"
      >
        <!-- 左側：システム名 -->
        <div class="col-4 col-md-3">
          <a
            class="navbar-brand fw-bold text-white"
            href="/resources/toppage.html"
          >
            <i class="bi bi-star-fill text-warning"></i>NSLibrary<i
              class="bi bi-star-fill text-warning"
            ></i>
          </a>
        </div>
        <!-- 中央：検索フォーム（伸縮対応） -->
        <div class="col-12 col-md-6 position-relative px-2">
          <!-- 入力欄をdivに変更し、hidden inputを追加 -->
          <form
            class="d-flex search-form"
            role="search"
            action="/resources/booksearch.html"
          >
            <!-- バッジ表示領域と実際の入力欄を分ける -->
            <div
              id="badgeInput"
              class="form-control me-2 d-flex flex-wrap align-items-center"
              style="min-height: 38px; cursor: text"
              onclick="searchInput.focus()"
            >
              <!-- バッジがここに追加される -->
              <input
                id="searchInput"
                type="text"
                class="border-0 flex-grow-1"
                style="outline: none"
                placeholder="書籍名・著者名など"
              />
            </div>
            <input type="hidden" name="tags" id="hiddenTags" />
            <button class="btn btn-outline-light" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </form>

          <!-- タグボタン表示 -->
          <div
            id="tagContainer"
            class="bg-light border rounded p-3 mt-2 shadow-sm"
            style="display: none; position: absolute; width: 100%; z-index: 10"
          >
            <div class="mb-2 fw-bold">難易度</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                初心者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                中級者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                上級者向け
              </button>
            </div>

            <div class="mb-2 fw-bold">ジャンル</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                文学・評論
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                ビジネス
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                AWS
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                自己啓発
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                暮らし・健康
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                アート・デザイン
              </button>
            </div>

            <div class="mb-2 fw-bold">職種</div>
            <div class="d-flex flex-wrap gap-2">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                インフラ系
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                アプリ
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                コンサル
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                営業
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                マネジメント
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                データ
              </button>
            </div>
          </div>
        </div>
        <script>
          const tagContainer = document.getElementById("tagContainer");
          const badgeInput = document.getElementById("badgeInput");
          const hiddenTags = document.getElementById("hiddenTags");

          searchInput.addEventListener("focus", () => {
            tagContainer.style.display = "block";
          });

          document.addEventListener("click", (event) => {
            const isClickInside =
              badgeInput.contains(event.target) ||
              tagContainer.contains(event.target);
            if (!isClickInside) {
              tagContainer.style.display = "none";
            }
          });

          function addTagBadge(tag) {
            const existingTags = Array.from(
              badgeInput.querySelectorAll(".tag-badge")
            ).map((b) => b.dataset.tag);
            if (existingTags.includes(tag)) return;

            const badge = document.createElement("span");
            badge.className = "badge rounded-pill badge-outline me-1 tag-badge"; // Bootstrapのバッジクラス
            badge.dataset.tag = tag;
            badge.innerHTML = `${tag} <span class="ms-1 remove-btn" style="cursor:pointer;">&times;</span>`;

            badge.querySelector(".remove-btn").addEventListener("click", () => {
              event.stopPropagation();
              badge.remove();
              updateHiddenTags();
            });

            badgeInput.insertBefore(badge, searchInput); // 入力欄の左に追加
            updateHiddenTags();
          }

          function updateHiddenTags() {
            const tags = Array.from(
              badgeInput.querySelectorAll(".tag-badge")
            ).map((b) => b.dataset.tag);
            hiddenTags.value = tags.join(" ");
          }

          document.querySelectorAll(".tag-btn").forEach((button) => {
            button.addEventListener("click", () => {
              const tag = button.textContent.trim();
              addTagBadge(tag);
            });
          });
          searchInput.addEventListener("keydown", (event) => {
            if (
              event.key === "Backspace" &&
              searchInput.value === "" // 入力欄が空のとき
            ) {
              const tagBadges = badgeInput.querySelectorAll(".tag-badge");
              if (tagBadges.length > 0) {
                const lastBadge = tagBadges[tagBadges.length - 1];
                lastBadge.remove();
                updateHiddenTags();
              }
            }
          });
          document
            .querySelector(".search-form")
            .addEventListener("submit", (event) => {
              const tags = Array.from(
                badgeInput.querySelectorAll(".tag-badge")
              ).map((b) => b.dataset.tag);

              const form = event.target;

              // 条件分岐で action を変更
              if (tags.includes("初心者向け") && tags.includes("AWS")) {
                form.action = "/resources/booksearchEasyAWS.html";
              } else if (tags.includes("初心者向け")) {
                form.action = "/resources/booksearchEasy.html";
              } else {
                form.action = "/resources/booksearch.html"; // デフォルト
              }
            });
        </script>

        <!-- 右側：貸出履歴表示 -->
        <div class="d-flex align-items-center gap-1">
          <a
            href="/resources/booklog.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-book fs-5 text-white me-2"></i>
            <span class="text-white fw-light">貸出履歴</span>
          </a>
          <a
            href="/resources/mypage.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-person-circle fs-5 text-white me-2"></i>
            <span id="loginMember" class="text-white fw-light"></span>
          </a>
        </div>
      </div>
    </nav>

    <!-- お気に入りゾーン -->
    <div
      id="favoritesZone"
      class="position-fixed bottom-0 end-0 p-3"
      style="width: 380px; max-height: 80vh; overflow-y: auto; z-index: 1050"
    >
      <div class="card shadow-sm" style="background-color: #fffafa">
        <!-- ヘッダー（クリックで開閉） -->
        <div
          id="favoritesHeader"
          class="card-header d-flex justify-content-between align-items-center px-3 py-2"
          style="
            background-color: #ffe4e1;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
          "
        >
          <span class="fw-semibold text-dark" style="font-size: 1.3rem">
            <i class="bi bi-heart-fill text-danger me-2"></i>お気に入り
          </span>
          <i id="favoritesToggleIcon" class="bi bi-chevron-down text-dark"></i>
        </div>
        <!-- コンテンツ（開閉対象） -->
        <div class="card-body p-2" id="favoritesList">
          <p class="text-muted small">まだ追加されていません。</p>
        </div>
      </div>
    </div>

    <div class="container my-5" style="max-width: 1200px; margin: auto">
      <div
        id="toast-container"
        class="toast-container position-fixed start-50 translate-middle-x bottom-0 p-3"
        style="z-index: 1055"
      ></div>
      <h1 class="mb-4" style="max-width: 1200px; margin: auto">
        <i class="bi bi-book"></i>
        本の詳細
      </h1>

      <div class="card mb-4" style="max-width: 1200px; margin: auto">
        <div class="row g-0">
          <div
            class="col-md-3 d-flex justify-content-center align-items-center"
          >
            <img id="bookImage" src="" class="img-fluid rounded-start" alt="" />
          </div>
          <div class="col-md-5">
            <div class="card-body d-flex flex-column h-100">
              <h3 id="bookTitle" class="card-title">bookTitle</h3>
              <p class="card-text">
                <span id="book-rating"></span>
              </p>
              <p class="card-text">
                <strong><i class="bi bi-person-fill"></i> 著者：</strong
                ><span id="bookAuthor">Author</span>
              </p>
              <p class="card-text">
                <strong><i class="bi bi-diagram-2"></i> ISBN：</strong>
                <span id="bookIsbn">ISBN</span>
              </p>
              <p class="card-text">
                <strong><i class="bi bi-calendar"></i> 出版年：</strong
                ><span id="bookYear">Year</span>
              </p>
              <p class="card-text">
                <span id="book-categories"></span>
              </p>
            </div>
          </div>

          <!-- 貸出可能な図書館一覧 -->
          <div class="col-md-4 border-start">
            <div class="card-body">
              <h5 class="card-title">蔵書場所</h5>
              <ul class="list-group list-group-flush" id="library-list"></ul>
            </div>
          </div>
        </div>
      </div>

      <!-- オプション: 本の説明やあらすじ -->
      <div class="container card" style="max-width: 1200px; margin: auto">
        <div class="card-header">
          <i class="bi bi-bookmark-dash"></i> この本について
        </div>
        <div class="card-body">
          <p class="card-text">
            <span id="bookDescription">Description</span>
          </p>
        </div>
      </div>

      <!-- おすすめ本（こちらもおすすめ） -->
      <div class="mt-5" style="max-width: 1200px; margin: auto">
        <h4 class="mb-3"><i class="bi bi-list-stars"></i> こちらもおすすめ</h4>
        <div
          id="recommendedBooks"
          class="scroll-container"
          style="
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 1rem;
            padding: 0.25rem 0.25rem 0.25rem 0.25rem;
            scroll-behavior: smooth;
            position: relative;
          "
        ></div>
      </div>

      <div
        id="review-section"
        class="mt-5"
        style="max-width: 1200px; margin: auto"
      >
        <h4 class="mb-3">
          <i class="bi bi-chat-square-heart"></i> 読者レビュー
        </h4>

        <!-- 本の総合評価をここに表示 -->
        <div id="average-rating" class="mt-4"></div>

        <div id="review-list" class="list-group"></div>
      </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const badges = document.querySelectorAll(".badge");

        badges.forEach(function (badge) {
          if (badge.textContent.trim() === "初心者向け") {
            badge.style.cursor = "pointer"; // 見た目でクリックできることを示す
            badge.addEventListener("click", function () {
              window.location.href = "booksearchEasy.html";
            });
          }
          if (badge.textContent.trim() === "AWS") {
            badge.style.cursor = "pointer"; // 見た目でクリックできることを示す
            badge.addEventListener("click", function () {
              window.location.href = "booksearch.html";
            });
          }
        });
      });

      /**
       * 星評価のHTMLを生成する関数
       * @param {number} rating - 星評価（例: 4.5）
       * @returns {string} - 星評価のHTML
       */
      function generateStarRating(rating) {
        const fullStars = Math.floor(rating); // 整数部分
        const decimal = Math.round((rating % 1) * 10); // 小数点第一位（0〜9）

        let starsHtml = "";

        // 完全な星（整数部分）
        for (let i = 0; i < fullStars; i++) {
          starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
        }

        // 小数点の星（1つだけ追加、ただし最大5個まで）
        if (fullStars < 5) {
          if (decimal >= 0 && decimal <= 2) {
            starsHtml += '<i class="bi bi-star text-warning"></i>';
          } else if (decimal >= 3 && decimal <= 7) {
            starsHtml += '<i class="bi bi-star-half text-warning"></i>';
          } else if (decimal >= 8 && decimal <= 9) {
            starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
          }
        }

        // 残りの空白星（最大5個まで）
        const currentStars = starsHtml.match(/<i/g)?.length || 0;
        for (let i = currentStars; i < 5; i++) {
          starsHtml += '<i class="bi bi-star text-warning"></i>';
        }

        return starsHtml;
      }

      /**
       * ログインユーザー名を表示
       * @param {number} loginMember - ログイン中の会員ID
       */
      const loginMember = 7;
      const memberEndpoint = `http://localhost:3000/members/${loginMember}`;

      fetch(memberEndpoint)
        .then((res) => res.json())
        .then((member) => {
          document.getElementById("loginMember").textContent = member.name;
        })
        .catch((err) => console.error("Error fetching member data:", err));

      /**
       * 書籍情報を表示
       * @param {number} bookId - 書籍ID
       */
      let book; // ← グローバルに宣言

      const params = new URLSearchParams(window.location.search);
      const id = params.get("id"); // → "3"（文字列として取得される）
      const bookEndpoint = `http://localhost:3000/books/${id}`; // 例外処理は無
      const categoriesEndpoint = `http://localhost:3000/categories`;
      const bookAllEndpoint = `http://localhost:3000/books`;

      Promise.all([
        fetch(bookEndpoint).then((res) => res.json()),
        fetch(categoriesEndpoint).then((res) => res.json()),
        fetch(bookAllEndpoint).then((res) => res.json()),
      ])
        .then(([bookData, categories, booksData]) => {
          // タイトルを表示
          book = bookData;
          document.getElementById("bookTitle").textContent = book.title;
          document.getElementById("bookAuthor").textContent = book.author;
          document.getElementById("bookIsbn").textContent = book.isbn;
          document.getElementById("bookYear").textContent = book.year;
          document.getElementById("bookDescription").textContent =
            book.description;
          document.getElementById("bookImage").src = book.image;
          document.getElementById("bookImage").alt = book.title;

          const categoryIds = Array.isArray(book.category)
            ? book.category
            : [book.category];

          const categoryNames = categoryIds.map((catId) => {
            const match = categories.find(
              (c) => Number(c.id) === Number(catId)
            );
            return match ? match.category : `不明（ID: ${catId}）`;
          });

          // カテゴリをバッジ形式で表示
          const categoryContainer = document.getElementById("book-categories");

          // ★ここに追加する！
          const favoritesKey = "favorites";
          let favorites = JSON.parse(localStorage.getItem(favoritesKey)) || [];
          const isFavorite = favorites.includes(book.id);

          const buttonHTML = isFavorite
            ? `<button class="btn btn-outline-secondary btn-sm mt-2 remove-favorite" data-id="${book.id}">
         <i class="bi bi-x"></i> お気に入りから削除
       </button>`
            : `<button class="btn btn-outline-danger btn-sm mt-2 favorite-btn" data-id="${book.id}">
         <i class="bi bi-heart"></i> お気に入りに追加
       </button>`;

          categoryContainer.innerHTML = `
            <strong><i class="bi bi-bookshelf"></i> タグ：</strong>
             ${categoryIds
               .map((catId) => {
                 const match = categories.find(
                   (c) => Number(c.id) === Number(catId)
                 );
                 const name = match ? match.category : `不明（ID: ${catId}）`;
                 return `<span class="badge rounded-pill badge-outline fs-6 me-1" data-id="${catId}">${name}</span>`;
               })
               .join("")}
               <!-- ← お気に入りに追加or削除ボタンを表示！ -->
          <br/>${buttonHTML}
          `;
          // カテゴリバッジをクリック可能にする
          document.addEventListener("click", function (e) {
            if (e.target.classList.contains("badge")) {
              const categoryId = e.target.getAttribute("data-id");
              if (categoryId) {
                window.location.href = `/resources/booksearch.html?tags=${categoryId}`;
              }
            }
          });
          // 評価（星）を表示
          const ratingElement = document.getElementById("book-rating");
          ratingElement.innerHTML = `
          <strong>評価：</strong>
          <a
                        href="#review-section"
                        class="rating-link text-warning text-decoration-none"
                      >
          <span class="text-warning">
            ${generateStarRating(book.stars)}
          </span>
          <span class="text-muted small ms-1">${book.stars.toFixed(1)} (${
            book.reviews
          }件)</span>
                  </a>
        `;
          const libraryStatusMap = {
            library1: { name: "虎ノ門", value: book.library1 },
            library2: { name: "新川", value: book.library2 },
            library3: { name: "みなとみらい", value: book.library3 },
          };

          const libraryList = document.getElementById("library-list");
          libraryList.innerHTML = ""; // 初期化

          Object.values(libraryStatusMap).forEach((library) => {
            const { name, value } = library;

            // -1 の場合は表示しない
            if (value === "-1" || value === -1) return;

            const li = document.createElement("li");
            li.className =
              "list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center";

            let badgeHtml = "";

            if (value === "1" || value === 1) {
              badgeHtml = `
            <span
              class="badge bg-success mt-2 mt-sm-0 badge-fixed borrow-button"
              data-book-id="${book.id}"
              data-location="${name}"
              data-book-title="${book.title}"
            >
              借りる
            </span>
          `;
            } else if (value === "0" || value === 0) {
              badgeHtml = `
            <span class="badge bg-danger mt-2 mt-sm-0 badge-fixed">
              貸出中
            </span>
          `;
            }

            li.innerHTML = `
          <span class="text-body">${name}</span>
          ${badgeHtml}
        `;

            libraryList.appendChild(li);
          });
          // ここからレコメンド
          const recommendedBooks = booksData.filter((b) => {
            const bCategories = Array.isArray(b.category)
              ? b.category.map((id) => Number(id))
              : [Number(b.category)];

            const sameLength = bCategories.length === categoryIds.length;
            const sameContent = categoryIds.every((id) =>
              bCategories.includes(id)
            );

            return sameLength && sameContent && b.id !== book.id;
          });

          const recommendedBooksContainer =
            document.getElementById("recommendedBooks");
          const recommendedSection = recommendedBooksContainer.parentElement;
          if (recommendedBooks.length === 0) {
            // おすすめがない場合はセクションを非表示
            recommendedSection.style.display = "none";
          } else {
            // 表示する場合は初期化してカードを追加
            recommendedBooksContainer.innerHTML = "";
            recommendedBooks.forEach((books) => {
              const bookCard = document.createElement("div");
              bookCard.className = "card card-hover mb-4 shadow-sm border-0";
              bookCard.style =
                "min-width: 200px; max-width: 200px; height: 300px";

              bookCard.innerHTML = `
              <a href="?id=${books.id}" class="text-decoration-none text-reset">
                  <img src="${books.image}" class="card-img-top" alt="${
                books.title
              }" style="height: 160px; object-fit: contain" />
                  <div class="card-body d-flex flex-column justify-content-start p-2">
                    <div>
                      <h6 class="card-title mb-0 title-clamp-2">${
                        books.title
                      }</h6>
                      <p class="card-text small text-muted mb-0 mt-1">${
                        books.author
                      }</p>
                    </div>
                    <p class="card-text mb-0">
                      <small class="text-warning">
                        ${generateStarRating(books.stars)}
                      </small>
                    </p>
                  </div>
                  </a>
                `;
              recommendedBooksContainer.appendChild(bookCard);
            });

            // 念のため表示を有効化
            recommendedSection.style.display = "block";
          }
        })
        .catch((err) =>
          console.error("Error fetching book or categories:", err)
        );

      let selectedLocation = null;

      let lastLogId = null;

      // イベント委任で borrow 処理を実行
      document.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("borrow-button")) {
          const bookId = Number(target.dataset.bookId);
          const location = target.dataset.location;
          const title = target.dataset.bookTitle;

          fetch("http://localhost:3000/logs")
            .then((res) => {
              if (!res.ok) throw new Error("ログ登録に失敗しました");
              return res.json();
            })
            .then((data) => {
              const maxId = data.reduce(
                (max, log) => Math.max(max, log.id || 0),
                0
              );
              const newId = maxId + 1;
              lastLogId = String(newId);

              const logData = {
                id: lastLogId,
                memberId: 7,
                bookId: bookId,
                loanDate: "2025/09/04",
                returnDate: null,
                returnLocation: location,
                returnFlag: false,
              };

              selectedLocation = location;

              // どのライブラリを更新するか決定
              let updateField = {};
              if (location === "虎ノ門") {
                updateField = { library1: "0" };
              } else if (location === "新川") {
                updateField = { library2: "0" };
              } else if (location === "みなとみらい") {
                updateField = { library3: "0" };
              }

              // booksテーブルをPATCHで更新
              return fetch(`http://localhost:3000/books/${bookId}`, {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updateField),
              })
                .then((res) => {
                  if (!res.ok) throw new Error("本の状態更新に失敗しました");
                  return res.json();
                })
                .then((updatedBook) => {
                  // ローカルの book オブジェクトにも反映（必要なら）
                  Object.assign(book, updatedBook);

                  // 再描画とアラート表示
                  renderLibraryList();
                  showBorrowAlert(title);

                  // logsテーブルにPOST
                  return fetch("http://localhost:3000/logs", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(logData),
                  });
                });
            })
            .catch((err) => {
              console.error("Error updating book or posting log:", err);
              alert("借りる処理に失敗しました");
            });
        }
      });

      function renderLibraryList() {
        const libraryStatusMap = {
          library1: { name: "虎ノ門", value: book.library1 },
          library2: { name: "新川", value: book.library2 },
          library3: { name: "みなとみらい", value: book.library3 },
        };

        const libraryList = document.getElementById("library-list");
        libraryList.innerHTML = "";

        Object.values(libraryStatusMap).forEach(({ name, value }) => {
          if (value === "-1" || value === -1) return;

          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center";

          let badgeHtml = "";
          if (value === "1" || value === 1) {
            badgeHtml = `<span class="badge bg-success mt-2 mt-sm-0 badge-fixed borrow-button" data-book-id="${book.id}" data-location="${name}" data-book-title="${book.title}">借りる</span>`;
          } else if (value === "0" || value === 0) {
            badgeHtml = `<span class="badge bg-danger mt-2 mt-sm-0 badge-fixed">貸出中</span>`;
          }

          li.innerHTML = `<span class="text-body">${name}</span> ${badgeHtml}`;
          libraryList.appendChild(li);
        });
      }

      // アラート表示関数
      function showBorrowAlert(title) {
        const toastContainer = document.getElementById("toast-container");

        const toast = document.createElement("div");
        toast.className =
          "toast fade animate-slide-up align-items-center custom-width text-bg-secondary border-0 show fs-5 px-4 py-3 rounded shadow";
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");

        toast.innerHTML = `
    <div class="d-flex justify-content-between align-items-center w-100">
      <div class="toast-body">
        <strong>『${title}』を借りました。</strong>
      </div>
      <button type="button" class="btn btn-outline-light me-2" id="cancelBorrow">取り消す</button>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;

        toastContainer.appendChild(toast);

        const bsToast = new bootstrap.Toast(toast, { autohide: false });
        bsToast.show();

        toast.querySelector("#cancelBorrow").addEventListener("click", () => {
          if (!lastLogId) return;

          // ログ削除
          fetch(`http://localhost:3000/logs/${lastLogId}`, {
            method: "DELETE",
          })
            .then((res) => {
              if (!res.ok) throw new Error("取り消しに失敗しました");

              // どのライブラリを元に戻すか決定
              let updateField = {};
              if (selectedLocation === "虎ノ門") {
                updateField = { library1: "1" };
              } else if (selectedLocation === "新川") {
                updateField = { library2: "1" };
              } else if (selectedLocation === "みなとみらい") {
                updateField = { library3: "1" };
              }

              // booksテーブルをPATCHで更新
              return fetch(`http://localhost:3000/books/${book.id}`, {
                method: "PATCH",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updateField),
              });
            })
            .then((res) => {
              if (!res.ok) throw new Error("本の状態更新に失敗しました");
              return res.json();
            })
            .then((updatedBook) => {
              Object.assign(book, updatedBook);
              renderLibraryList();
              showToast("借りる処理を取り消しました", "outline-secondary");
              lastLogId = null;
              bsToast.hide();
            })
            .catch((err) => {
              console.error("Error deleting log or updating book:", err);
              alert("取り消しに失敗しました");
            });
        });
      }

      function showToast(message, type = "dark") {
        const toastContainer = document.getElementById("toast-container");

        const toast = document.createElement("div");
        toast.className = `toast fade animate-slide-up custom-width align-items-center text-bg-${type} border-0 show fs-5 px-4 py-3 rounded shadow`;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");

        toast.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;

        toastContainer.appendChild(toast);

        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
      }

      /**
       * レビュー一覧と平均評価を表示
       * @param {number} bookId - 本のID
       */
      const reviewsEndpoint = `http://localhost:3000/reviews?bookId=${id}`; // 例外処理は無
      const membersEndpoint = `http://localhost:3000/members`;

      let members = [];

      fetch(membersEndpoint)
        .then((res) => res.json())
        .then((data) => {
          members = data;
          return fetch(reviewsEndpoint);
        })
        .then((res) => res.json())
        .then((reviews) => {
          const reviewList = document.getElementById("review-list");
          reviewList.innerHTML = "";

          let totalStars = 0;
          let count = 0;

          reviews.forEach((review) => {
            // 平均点の計算にはすべてのレビューを含める
            totalStars += review.stars;
            count++;

            // コメントが空白なら表示しない
            if (!review.comment || review.comment.trim() === "") return;

            const member = members.find(
              (m) => Number(m.id) === review.memberId
            );

            const reviewerName = `${member.name}（${member.department}・${member.occupation}・${member.position}）`;

            const item = document.createElement("div");
            item.className = "list-group-item";

            item.innerHTML = `
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-fill me-2"></i>
                  <a href="mypage.html?id=${
                    member.id
                  }" class="fw-bold review-link">${reviewerName}</a>
                </div>
                <small class="text-warning">
                  ${generateStarRating(review.stars)}
                </small>
              </div>
              <p class="mb-0">${review.comment}</p>
            `;

            reviewList.appendChild(item);
          });

          // 平均点を表示（すべてのレビュー対象）
          const avgContainer = document.getElementById("average-rating");
          if (count > 0) {
            const avg = (totalStars / count).toFixed(1);
            avgContainer.innerHTML = `
          <h5>この本の評価</h5>
          <small class="text-warning fs-4">
            ${generateStarRating(avg)}
          </small>
          <span class="text-muted mx-1">${avg} (${count}件)</span>
        `;
          } else {
            avgContainer.innerHTML = `<p class="text-muted">レビューがまだありません。</p>`;
          }
        })
        .catch((err) =>
          console.error("Error fetching reviews or members:", err)
        );
    </script>
    <script>
      // お気に入りゾーン関連
      const favoritesKey = "favorites";
      let favorites = JSON.parse(localStorage.getItem(favoritesKey)) || [];

      function saveFavorites() {
        localStorage.setItem(favoritesKey, JSON.stringify(favorites));
      }

      function renderFavorites(bookData) {
        const favoritesList = document.getElementById("favoritesList");
        const favoriteBooks = bookData.filter((book) =>
          favorites.includes(book.id)
        );

        if (favoriteBooks.length === 0) {
          favoritesList.innerHTML = `<p class="text-muted small">まだ追加されていません。</p>`;
          return;
        }

        favoritesList.innerHTML = favoriteBooks
          .map(
            (book) => `
        <div class="d-flex align-items-center justify-content-between mb-4">
          <a href="bookDetail.html?id=${book.id}" class="text-decoration-none d-flex align-items-center">
            <img src="${book.image}" alt="${book.title}" style="width: 40px;" class="me-2 rounded shadow-sm" />
            <span class="favorite-title"" style="max-width: 160px;">${book.title}</span>
          </a>
          <button class="btn btn-sm btn-outline-secondary remove-favorite" data-id="${book.id}">
            削除
          </button>
        </div>
      `
          )
          .join("");
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetch("/jsons/db.json")
          .then((res) => res.json())
          .then((data) => {
            const bookData = data.books;
            renderFavorites(bookData);

            document.addEventListener("click", (e) => {
              const addBtn = e.target.closest(".favorite-btn");
              const removeBtn = e.target.closest(".remove-favorite");

              if (addBtn) {
                const bookId = addBtn.dataset.id;
                if (!favorites.includes(bookId)) {
                  favorites.push(bookId);
                  saveFavorites();
                  renderFavorites(bookData);
                  addBtn.innerHTML = `<i class="bi bi-x"></i> お気に入りから削除`;
                  addBtn.classList.remove("btn-outline-danger");
                  addBtn.classList.add(
                    "btn-outline-secondary",
                    "remove-favorite"
                  );
                }
              }

              if (removeBtn) {
                const bookId = removeBtn.dataset.id;
                favorites = favorites.filter((id) => id !== bookId);
                saveFavorites();
                renderFavorites(bookData);

                const originalBtn = document.querySelector(
                  `.favorite-btn[data-id="${bookId}"]`
                );
                if (originalBtn) {
                  originalBtn.innerHTML = `<i class="bi bi-heart"></i> お気に入りに追加`;
                  originalBtn.classList.remove(
                    "btn-outline-secondary",
                    "remove-favorite"
                  );
                  originalBtn.classList.add("btn-outline-danger");
                }
              }
            });
          });
      });
    </script>
    <script>
      const header = document.getElementById("favoritesHeader");
      const list = document.getElementById("favoritesList");
      const icon = document.getElementById("favoritesToggleIcon");

      let isOpen = true;

      header.addEventListener("click", () => {
        isOpen = !isOpen;
        list.style.display = isOpen ? "block" : "none";
        icon.className = isOpen
          ? "bi bi-chevron-down text-dark"
          : "bi bi-chevron-up text-dark";
      });
    </script>
  </body>
</html>
