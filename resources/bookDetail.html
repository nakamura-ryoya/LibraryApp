<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>社内図書サービス</title>
    <!-- Bootstrap CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/resources/style.css" />
  </head>
  <body>
    <!-- ナビバー -->
    <nav class="navbar sticky-top">
      <div
        class="container d-flex flex-wrap justify-content-between align-items-center"
        style="max-width: 1200px; margin: auto"
      >
        <!-- 左側：システム名 -->
        <div class="col-4 col-md-3">
          <a
            class="navbar-brand fw-bold text-white"
            href="/resources/toppage.html"
          >
            <i class="bi bi-star-fill text-warning"></i>NSLibrary<i
              class="bi bi-star-fill text-warning"
            ></i>
          </a>
        </div>
        <!-- 中央：検索フォーム（伸縮対応） -->
        <div class="col-12 col-md-6 position-relative px-2">
          <!-- 入力欄をdivに変更し、hidden inputを追加 -->
          <form
            class="d-flex search-form"
            role="search"
            action="/resources/booksearch.html"
          >
            <!-- バッジ表示領域と実際の入力欄を分ける -->
            <div
              id="badgeInput"
              class="form-control me-2 d-flex flex-wrap align-items-center"
              style="min-height: 38px; cursor: text"
              onclick="searchInput.focus()"
            >
              <!-- バッジがここに追加される -->
              <input
                id="searchInput"
                type="text"
                class="border-0 flex-grow-1"
                style="outline: none"
                placeholder="書籍名・著者名など"
              />
            </div>
            <input type="hidden" name="tags" id="hiddenTags" />
            <button class="btn btn-outline-light" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </form>

          <!-- タグボタン表示 -->
          <div
            id="tagContainer"
            class="bg-light border rounded p-3 mt-2 shadow-sm"
            style="display: none; position: absolute; width: 100%; z-index: 10"
          >
            <div class="mb-2 fw-bold">難易度</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                初心者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                中級者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                上級者向け
              </button>
            </div>

            <div class="mb-2 fw-bold">ジャンル</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                文学・評論
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                ビジネス
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                AWS
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                自己啓発
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                暮らし・健康
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                アート・デザイン
              </button>
            </div>

            <div class="mb-2 fw-bold">職種</div>
            <div class="d-flex flex-wrap gap-2">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                インフラ系
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                アプリ
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                コンサル
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                営業
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                マネジメント
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                データ
              </button>
            </div>
          </div>
        </div>
        <script>
          const tagContainer = document.getElementById("tagContainer");
          const badgeInput = document.getElementById("badgeInput");
          const hiddenTags = document.getElementById("hiddenTags");

          searchInput.addEventListener("focus", () => {
            tagContainer.style.display = "block";
          });

          document.addEventListener("click", (event) => {
            const isClickInside =
              badgeInput.contains(event.target) ||
              tagContainer.contains(event.target);
            if (!isClickInside) {
              tagContainer.style.display = "none";
            }
          });

          function addTagBadge(tag) {
            const existingTags = Array.from(
              badgeInput.querySelectorAll(".tag-badge")
            ).map((b) => b.dataset.tag);
            if (existingTags.includes(tag)) return;

            const badge = document.createElement("span");
            badge.className = "badge rounded-pill badge-outline me-1 tag-badge"; // Bootstrapのバッジクラス
            badge.dataset.tag = tag;
            badge.innerHTML = `${tag} <span class="ms-1 remove-btn" style="cursor:pointer;">&times;</span>`;

            badge.querySelector(".remove-btn").addEventListener("click", () => {
              event.stopPropagation();
              badge.remove();
              updateHiddenTags();
            });

            badgeInput.insertBefore(badge, searchInput); // 入力欄の左に追加
            updateHiddenTags();
          }

          function updateHiddenTags() {
            const tags = Array.from(
              badgeInput.querySelectorAll(".tag-badge")
            ).map((b) => b.dataset.tag);
            hiddenTags.value = tags.join(" ");
          }

          document.querySelectorAll(".tag-btn").forEach((button) => {
            button.addEventListener("click", () => {
              const tag = button.textContent.trim();
              addTagBadge(tag);
            });
          });
          searchInput.addEventListener("keydown", (event) => {
            if (
              event.key === "Backspace" &&
              searchInput.value === "" // 入力欄が空のとき
            ) {
              const tagBadges = badgeInput.querySelectorAll(".tag-badge");
              if (tagBadges.length > 0) {
                const lastBadge = tagBadges[tagBadges.length - 1];
                lastBadge.remove();
                updateHiddenTags();
              }
            }
          });
          document
            .querySelector(".search-form")
            .addEventListener("submit", (event) => {
              const tags = Array.from(
                badgeInput.querySelectorAll(".tag-badge")
              ).map((b) => b.dataset.tag);

              const form = event.target;

              // 条件分岐で action を変更
              if (tags.includes("初心者向け") && tags.includes("AWS")) {
                form.action = "/resources/booksearchEasyAWS.html";
              } else if (tags.includes("初心者向け")) {
                form.action = "/resources/booksearchEasy.html";
              } else {
                form.action = "/resources/booksearch.html"; // デフォルト
              }
            });
        </script>

        <!-- 右側：貸出履歴表示 -->
        <div class="d-flex align-items-center gap-1">
          <a
            href="/resources/booklog.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-book fs-5 text-white me-2"></i>
            <span class="text-white fw-light">貸出履歴</span>
          </a>
          <a
            href="/resources/mypage.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-person-circle fs-5 text-white me-2"></i>
            <span id="loginMember" class="text-white fw-light"></span>
          </a>
        </div>
      </div>
    </nav>

    <div class="container my-5" style="max-width: 1200px; margin: auto">
      <h1 class="mb-4" style="max-width: 1200px; margin: auto">
        <i class="bi bi-book"></i>
        本の詳細
      </h1>

      <div class="card mb-4" style="max-width: 1200px; margin: auto">
        <div class="row g-0">
          <div
            class="col-md-3 d-flex justify-content-center align-items-center"
          >
            <img
              src="/images/book1.png"
              class="img-fluid rounded-start"
              alt="図解AWSの仕組みとサービスがよく分かる！"
            />
          </div>
          <div class="col-md-5">
            <div class="card-body d-flex flex-column h-100">
              <h3 id="bookTitle" class="card-title">bookTitle</h3>
              <p class="card-text">
                <strong>評価：</strong>
                <a
                  href="#review-section"
                  class="rating-link text-warning text-decoration-none"
                >
                  <i class="bi bi-star-fill text-warning"></i>
                  <i class="bi bi-star-fill text-warning"></i>
                  <i class="bi bi-star-fill text-warning"></i>
                  <i class="bi bi-star-fill text-warning"></i>
                  <i class="bi bi-star-half text-warning"></i>
                  <span class="text-muted small mx-1">4.6 (13件)</span>
                </a>
              </p>
              <p class="card-text">
                <strong><i class="bi bi-person-fill"></i> 著者：</strong
                ><span id="bookAuthor">Author</span>
              </p>
              <p class="card-text">
                <strong><i class="bi bi-diagram-2"></i> ISBN：</strong>
                <span id="bookIsbn">ISBN</span>
              </p>
              <p class="card-text">
                <strong><i class="bi bi-calendar"></i> 出版年：</strong
                ><span id="bookYear">Year</span>
              </p>
              <p class="card-text">
                <strong><i class="bi bi-bookshelf"></i> ジャンル：</strong>
                <span class="badge rounded-pill badge-outline me-1"
                  >初心者向け</span
                >
                <span class="badge rounded-pill badge-outline me-1"> AWS </span>
                <span class="badge rounded-pill badge-outline me-1"
                  >インフラ系</span
                >
              </p>
              <!-- <p class="card-text">
                <strong><i class="bi bi-chat-left-text"></i> 概要：</strong
                ><br />
                AWSの主要サービス（EC2、S3、Lambda、RDSなど）を図解でわかりやすく解説。インフラの構成図やデータフロー、料金体系などをビジュアルで理解できる構成になっており、初心者から中級者まで幅広く対応。
              </p> -->
              <!-- <div class="mt-auto pt-3">
                <button class="btn btn-primary me-2">
                  <i class="bi bi-book-fill"></i> 借りる
                </button>
                <button class="btn btn-secondary">
                  <i class="bi bi-arrow-left"></i> 戻る
                </button>
              </div> -->
            </div>
          </div>

          <!-- 貸出可能な図書館一覧 -->
          <div class="col-md-4 border-start">
            <div class="card-body">
              <h5 class="card-title">蔵書場所</h5>
              <ul class="list-group list-group-flush">
                <li
                  class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center"
                >
                  <span class="text-body">虎ノ門ヒルズビジネスタワー13F</span>
                  <span
                    class="badge bg-success mt-2 mt-sm-0 badge-fixed"
                    data-bs-toggle="modal"
                    data-bs-target="#borrowModal"
                  >
                    借りる
                  </span>
                </li>
                <li
                  class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center"
                >
                  <span class="text-body">住友ツインビル13F</span>
                  <span class="badge bg-danger mt-2 mt-sm-0 badge-fixed"
                    >貸出中</span
                  >
                </li>
                <li
                  class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center"
                >
                  <span class="text-body">みなとみらい</span>
                  <span class="badge bg-danger mt-2 mt-sm-0 badge-fixed"
                    >貸出中</span
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- 借りる確認モーダル -->
      <div
        class="modal fade"
        id="borrowModal"
        tabindex="-1"
        aria-labelledby="borrowModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="borrowModalLabel">確認画面</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="閉じる"
              ></button>
            </div>
            <div class="modal-body">
              <p><strong>この本を借りますか？</strong></p>
              <strong>タイトル：</strong>
              図解AWSの仕組みとサービスがよく分かる！
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                キャンセル
              </button>
              <button
                type="button"
                class="btn btn-success"
                data-bs-target="#borrowResultModal"
                data-bs-toggle="modal"
                data-bs-dismiss="modal"
              >
                借りる
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 借りた結果モーダル -->
      <div
        class="modal fade"
        id="borrowResultModal"
        tabindex="-1"
        aria-labelledby="borrowResultModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="borrowResultModalLabel">
                以下の本を借りました
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="閉じる"
              ></button>
            </div>
            <div class="modal-body">
              <p>
                <strong>タイトル：</strong>
                図解AWSの仕組みとサービスがよく分かる！
              </p>

              <strong>返却期限：</strong> 2025/09/30
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-primary"
                data-bs-dismiss="modal"
              >
                閉じる
              </button>
            </div>
          </div>
        </div>
      </div>

      <script>
        const modal = document.getElementById("borrowResultModal");

        modal.addEventListener("hidden.bs.modal", function () {
          window.location.href = "/resources/Borrowed/book1Detail.html";
        });
      </script>

      <!-- オプション: 本の説明やあらすじ -->
      <div class="container card" style="max-width: 1200px; margin: auto">
        <div class="card-header">
          <i class="bi bi-bookmark-dash"></i> この本について
        </div>
        <div class="card-body">
          <p class="card-text">
            <span id="bookDescription">Description</span>
          </p>
        </div>
      </div>

      <!-- おすすめ本（こちらもおすすめ） -->
      <div class="mt-5" style="max-width: 1200px; margin: auto">
        <h4 class="mb-3"><i class="bi bi-list-stars"></i> こちらもおすすめ</h4>
        <div
          id="recommendedBooks"
          class="scroll-container"
          style="
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 1rem;
            padding: 0.25rem 0.25rem 0.25rem 0.25rem;
            scroll-behavior: smooth;
            position: relative;
          "
        ></div>
      </div>

      <div
        id="review-section"
        class="mt-5"
        style="max-width: 1200px; margin: auto"
      >
        <h4 class="mb-3">
          <i class="bi bi-chat-square-heart"></i> 読者レビュー
        </h4>

        <!-- 本の総合評価をここに表示 -->
        <div id="average-rating" class="mt-4"></div>

        <div id="review-list" class="list-group"></div>
      </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const badges = document.querySelectorAll(".badge");

        badges.forEach(function (badge) {
          if (badge.textContent.trim() === "初心者向け") {
            badge.style.cursor = "pointer"; // 見た目でクリックできることを示す
            badge.addEventListener("click", function () {
              window.location.href = "booksearchEasy.html";
            });
          }
          if (badge.textContent.trim() === "AWS") {
            badge.style.cursor = "pointer"; // 見た目でクリックできることを示す
            badge.addEventListener("click", function () {
              window.location.href = "booksearch.html";
            });
          }
        });
      });

      /**
       * 星評価のHTMLを生成する関数
       * @param {number} rating - 星評価（例: 4.5）
       * @returns {string} - 星評価のHTML
       */
      function generateStarRating(rating) {
        const fullStars = Math.floor(rating); // 整数部分
        const decimal = Math.round((rating % 1) * 10); // 小数点第一位（0〜9）

        let starsHtml = "";

        // 完全な星（整数部分）
        for (let i = 0; i < fullStars; i++) {
          starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
        }

        // 小数点の星（1つだけ追加、ただし最大5個まで）
        if (fullStars < 5) {
          if (decimal >= 0 && decimal <= 2) {
            starsHtml += '<i class="bi bi-star text-warning"></i>';
          } else if (decimal >= 3 && decimal <= 7) {
            starsHtml += '<i class="bi bi-star-half text-warning"></i>';
          } else if (decimal >= 8 && decimal <= 9) {
            starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
          }
        }

        // 残りの空白星（最大5個まで）
        const currentStars = starsHtml.match(/<i/g)?.length || 0;
        for (let i = currentStars; i < 5; i++) {
          starsHtml += '<i class="bi bi-star text-warning"></i>';
        }

        return starsHtml;
      }

      /**
       * ログインユーザー名を表示
       * @param {number} loginMember - ログイン中の会員ID
       */
      const loginMember = 7;
      const memberEndpoint = `http://localhost:3000/members/${loginMember}`;

      fetch(memberEndpoint)
        .then((res) => res.json())
        .then((member) => {
          document.getElementById("loginMember").textContent = member.name;
        })
        .catch((err) => console.error("Error fetching member data:", err));

      /**
       * 書籍情報を表示
       * @param {number} bookId - 書籍ID
       */
      const bookId = 1;
      const bookEndpoint = `http://localhost:3000/books/${bookId}`;

      fetch(bookEndpoint)
        .then((res) => res.json())
        .then((book) => {
          document.getElementById("bookTitle").textContent = book.title;
          document.getElementById("bookIsbn").textContent = book.isbn;
          document.getElementById("bookYear").textContent = book.year;
          document.getElementById("bookDescription").textContent =
            book.description;
        })
        .catch((err) => console.error("Error fetching member data:", err));

      /**
       * あなたへのおすすめの本を表示
       * @param {number} loginMember - ログイン中の会員ID
       */
      const booksEndpoint = `http://localhost:3000/books`;

      fetch(booksEndpoint)
        .then((res) => res.json())
        .then((books) => {
          const recommendedBooksContainer =
            document.getElementById("recommendedBooks");
          books.forEach((book) => {
            const bookCard = document.createElement("div");
            bookCard.className = "card card-hover mb-4 shadow-sm border-0";
            bookCard.style =
              "min-width: 200px; max-width: 200px; height: 300px";

            bookCard.innerHTML = `
              <img src="${book.image}" class="card-img-top" alt="${
              book.title
            }" style="height: 160px; object-fit: contain" />
              <div class="card-body d-flex flex-column justify-content-start p-2">
                <div>
                  <h6 class="card-title mb-0 title-clamp-2">${book.title}</h6>
                  <p class="card-text small text-muted mb-0 mt-1">${
                    book.author
                  }</p>
                </div>
                <p class="card-text mb-0">
                  <small class="text-warning">
                    ${generateStarRating(book.stars)}
                  </small>
                </p>
              </div>
            `;
            recommendedBooksContainer.appendChild(bookCard);
          });
        })
        .catch((err) => console.error("Error fetching books data:", err));

      /**
       * レビュー一覧と平均評価を表示
       * @param {number} bookId - 本のID
       */
      // const bookId = 1; 上で使っているのでコメントアウト
      const reviewsEndpoint = `http://localhost:3000/reviews?bookId=${bookId}`;
      const membersEndpoint = `http://localhost:3000/members`;

      let members = [];

      fetch(membersEndpoint)
        .then((res) => res.json())
        .then((data) => {
          members = data;
          return fetch(reviewsEndpoint);
        })
        .then((res) => res.json())
        .then((reviews) => {
          const reviewList = document.getElementById("review-list");
          reviewList.innerHTML = "";

          let totalStars = 0;
          let count = 0;

          reviews.forEach((review) => {
            // 平均点の計算にはすべてのレビューを含める
            totalStars += review.stars;
            count++;

            // コメントが空白なら表示しない
            if (!review.comment || review.comment.trim() === "") return;

            const member = members.find(
              (m) => Number(m.id) === review.memberId
            );

            const reviewerName = `${member.name}（${member.department}・${member.occupation}・${member.position}）`;

            const item = document.createElement("div");
            item.className = "list-group-item";

            item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="d-flex align-items-center">
            <i class="bi bi-person-fill me-2"></i>
            <strong>${reviewerName}</strong>
          </div>
          <small class="text-warning">
            ${generateStarRating(review.stars)}
          </small>
        </div>
        <p class="mb-0">${review.comment}</p>
      `;

            reviewList.appendChild(item);
          });

          // 平均点を表示（すべてのレビュー対象）
          const avgContainer = document.getElementById("average-rating");
          if (count > 0) {
            const avg = (totalStars / count).toFixed(1);
            avgContainer.innerHTML = `
    <h5>この本の評価</h5>
    <small class="text-warning fs-4">
      ${generateStarRating(avg)}
    </small>
    <span class="text-muted mx-1">${avg} (${count}件)</span>
  `;
          } else {
            avgContainer.innerHTML = `<p class="text-muted">レビューがまだありません。</p>`;
          }
        })
        .catch((err) =>
          console.error("Error fetching reviews or members:", err)
        );
    </script>
  </body>
</html>
