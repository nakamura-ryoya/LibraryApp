<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>社内図書館システム</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <link rel="stylesheet" href="/resources/style.css" />
  </head>

  <body>
    <!-- ナビバー -->
    <nav class="navbar sticky-top">
      <div
        class="container d-flex flex-wrap justify-content-between align-items-center"
        style="max-width: 1200px; margin: auto"
      >
        <!-- 左側：システム名 -->
        <div class="col-4 col-md-3">
          <a
            class="navbar-brand fw-bold text-white"
            href="/resources/toppage.html"
          >
            <i class="bi bi-star-fill text-warning"></i>NSLibrary<i
              class="bi bi-star-fill text-warning"
            ></i>
          </a>
        </div>
        <!-- 中央：検索フォーム（伸縮対応） -->
        <div class="col-12 col-md-6 position-relative px-2">
          <!-- 入力欄をdivに変更し、hidden inputを追加 -->
          <form
            class="d-flex search-form"
            role="search"
            action="/resources/booksearch.html"
          >
            <!-- バッジ表示領域と実際の入力欄を分ける -->
            <div
              id="badgeInput"
              class="form-control me-2 d-flex flex-wrap align-items-center"
              style="min-height: 38px; cursor: text"
              onclick="searchInput.focus()"
            >
              <!-- バッジがここに追加される -->
              <input
                id="searchInput"
                type="text"
                class="border-0 flex-grow-1"
                style="outline: none"
                placeholder="書籍名・著者名など"
              />
            </div>
            <input type="hidden" name="tags" id="hiddenTags" />
            <button class="btn btn-outline-light" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </form>

          <!-- タグボタン表示 -->
          <div
            id="tagContainer"
            class="bg-light border rounded p-3 mt-2 shadow-sm"
            style="display: none; position: absolute; width: 100%; z-index: 10"
          >
            <div class="mb-2 fw-bold">難易度</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                初心者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                中級者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                上級者向け
              </button>
            </div>

            <div class="mb-2 fw-bold">ジャンル</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                文学・評論
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                ビジネス
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                AWS
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                自己啓発
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                暮らし・健康
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                アート・デザイン
              </button>
            </div>

            <div class="mb-2 fw-bold">職種</div>
            <div class="d-flex flex-wrap gap-2">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                インフラ系
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                アプリ
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                コンサル
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                営業
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                マネジメント
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                データ
              </button>
            </div>
          </div>
        </div>
        <script>
                const tagContainer = document.getElementById("tagContainer");
                const badgeInput = document.getElementById("badgeInput");
                const hiddenTags = document.getElementById("hiddenTags");

                searchInput.addEventListener("focus", () => {
                  tagContainer.style.display = "block";
                });

                document.addEventListener("click", (event) => {
                  const isClickInside =
                    badgeInput.contains(event.target) ||
                    tagContainer.contains(event.target);
                  if (!isClickInside) {
                    tagContainer.style.display = "none";
                  }
                });

                function updateHiddenTags() {
                  const tags = Array.from(
                    badgeInput.querySelectorAll(".tag-badge")
                  ).map((b) => b.dataset.tag);
                  hiddenTags.value = tags.join(" ");
                }

                function updateTagButtonStyles() {
                  const selectedTags = Array.from(
                    badgeInput.querySelectorAll(".tag-badge")
                  ).map((b) => b.dataset.tag);

                  document.querySelectorAll(".tag-btn").forEach((button) => {
                    const tag = button.textContent.trim();
                    if (selectedTags.includes(tag)) {
                      button.classList.add("tag-btn-selected");
                    } else {
                      button.classList.remove("tag-btn-selected");
                    }
                  });
                }

                function toggleTagBadge(tag) {
                  const existingBadge = Array.from(
                    badgeInput.querySelectorAll(".tag-badge")
                  ).find((b) => b.dataset.tag === tag);

                  if (existingBadge) {
                    existingBadge.remove();
                  } else {
                    const badge = document.createElement("span");
                    badge.className =
                      "badge rounded-pill badge-outline me-1 tag-badge";
                    badge.dataset.tag = tag;
                    badge.innerHTML = `${tag} <span class="ms-1 remove-btn" style="cursor:pointer;">&times;</span>`;

                    badge
                      .querySelector(".remove-btn")
                      .addEventListener("click", (event) => {
                        event.stopPropagation();
                        badge.remove();
                        updateHiddenTags();
                        updateTagButtonStyles();
                      });

                    badgeInput.insertBefore(badge, searchInput);
                  }

                  updateHiddenTags();
                  updateTagButtonStyles();
                }

                document.querySelectorAll(".tag-btn").forEach((button) => {
                  button.addEventListener("click", () => {
                    const tag = button.textContent.trim();
                    toggleTagBadge(tag);
                  });
                });
                searchInput.addEventListener("keydown", (event) => {
                  if (
                    event.key === "Backspace" &&
                    searchInput.value === "" // 入力欄が空のとき
                  ) {
                    const tagBadges = badgeInput.querySelectorAll(".tag-badge");
                    if (tagBadges.length > 0) {
                      const lastBadge = tagBadges[tagBadges.length - 1];
                      lastBadge.remove();
                      updateHiddenTags();
                      updateTagButtonStyles();
                    }
                  }
                });
                document
                  .querySelector(".search-form")
                  .addEventListener("submit", (event) => {
                    event.preventDefault(); // デフォルトの送信を防止
                    // タグ名とクエリパラメータのマッピング
                    const tagQueryMap = {
                      初心者向け: "1",
                      中級者向け: "2",
                      上級者向け: "3",
                      文学・評論: "4",
                      ビジネス: "5",
                      AWS: "6",
                      自己啓発: "7",
                      暮らし・健康: "8",
                      アート・デザイン: "9",
                      インフラ系: "10",
                      アプリ: "11",
                      コンサル: "12",
                      営業: "13",
                      マネジメント: "14",
                      データ: "15",
                      // 必要に応じて追加
                    };
                    // 選択されたタグを取得
          const selectedTags = Array.from(
            document.querySelectorAll(".tag-badge")
          ).map((badge) => badge.dataset.tag);

          // 対応するIDを取得
          const selectedIds = selectedTags
            .map((tag) => tagQueryMap[tag])
            .filter((id) => id !== undefined);

          // クエリパラメータを生成
          const queryString = selectedIds.length > 0 ? `?tags=${selectedIds.join(",")}` : "";

          // URLを設定して送信
          const form = event.target;
          const targetUrl = `/resources/booksearch.html${queryString}`;
          window.location.href = targetUrl;
                  });
        </script>

        <!-- 右側：貸出履歴表示 -->
        <div class="d-flex align-items-center gap-1">
          <a
            href="/resources/booklog.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-book fs-5 text-white me-2"></i>
            <span class="text-white fw-light">貸出履歴</span>
          </a>
          <a
            href="/resources/mypage.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-person-circle fs-5 text-white me-2"></i>
            <span class="text-white fw-light">石倉 加菜子</span>
          </a>
        </div>
      </div>
    </nav>
    <!-- 検索結果タイトル -->
    <h1 class="text-center mb-4 mt-4">貸出履歴</h1>

    <!-- 検索結果カード -->
    <div class="container" id="logCardContainer"></div>

    <!-- 返却するボタン・モーダル(確定するボタンを内包している)-->
    <div
      class="modal fade"
      id="returnModal"
      tabindex="-1"
      aria-labelledby="returnModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="returnModalLabel">
              本の返却とレビュー
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="閉じる"
            ></button>
          </div>
          <div class="modal-body">
            <!-- 評価 -->
            <label class="form-label">評価（星1〜5）</label>
            <select id="rating" class="form-select mb-3">
              <option value="1">★☆☆☆☆</option>
              <option value="2">★★☆☆☆</option>
              <option value="3">★★★☆☆</option>
              <option value="4">★★★★☆</option>
              <option value="5">★★★★★</option>
            </select>

            <label class="form-label"
              >この本の難易度はどのレベルだと感じましたか？</label
            >
            <div class="btn-group mb-3" role="group" aria-label="対象レベル">
              <input
                type="radio"
                class="btn-check"
                name="level"
                id="beginner"
                value="0"
                autocomplete="off"
              />
              <label class="btn btn-outline-primary" for="beginner"
                >初級者向け</label
              >

              <input
                type="radio"
                class="btn-check"
                name="level"
                id="intermediate"
                value="1"
                autocomplete="off"
              />
              <label class="btn btn-outline-primary" for="intermediate"
                >中級者向け</label
              >

              <input
                type="radio"
                class="btn-check"
                name="level"
                id="advanced"
                value="2"
                autocomplete="off"
              />
              <label class="btn btn-outline-primary" for="advanced"
                >上級者向け</label
              >
            </div>
            <br />

            <!-- コメント -->
            <label class="form-label">コメント</label>
            <textarea
              id="comment"
              class="form-control"
              rows="3"
              placeholder="この本の感想を入力してください"
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              キャンセル
            </button>
            <button type="button" class="btn btn-primary" id="confirmReturn">
              確定
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 確定するを押したときのアクション、選択しているlogs.logのbookIdを取得する。
     jsonの
     logs.logのreturnDate=今日の日付とreturnFlag=1
     logs.logのreturnLocationが「虎ノ門オフィス」だったら、books.bookのlibrary1を1に変更

     1 借りる
     0 貸出中
     -1 蔵書なし
     -->
    <!-- containerをforeach表示 javascript-->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loginMember = 7;
        Promise.all([
          fetch("http://localhost:3000/logs").then((res) => res.json()),
          fetch("http://localhost:3000/books").then((res) => res.json()),
          fetch(`http://localhost:3000/members/${loginMember}`).then((res) =>
            res.json()
          ),
        ])
          .then(([logs, books, member]) => {
            const container = document.getElementById("logCardContainer");

            // memberIdが7のログだけ抽出
            console.log("取得したメンバーID:", member.id);
            console.log("取得したログ一覧:", logs);
            // 石倉さんの貸出履歴
            const filteredLogs = logs.filter(
              (log) => log.memberId === Number(member.id)
            );
            console.log(filteredLogs);

            filteredLogs.forEach((log) => {
              console.log(log.bookId);
              const book = books.find((b) => Number(b.id) === log.bookId);
              console.log("book", book);
              if (!book) return;

              const card = document.createElement("div");
              card.className = "card card-hover mb-4 shadow-sm border-0";
              card.style.maxWidth = "1200px";
              card.style.margin = "auto";

              card.innerHTML = `
                        <div class="row g-0">
                          <a href="book1Detail.html" class="stretched-link"></a>
                          <!-- 画像 -->
                          <div class="col-md-2 d-flex justify-content-center align-items-center py-2 px-1 border-end">
                            <img src="${
                              book.image
                            }" class="img-fluid rounded" alt="蔵書画像" style="max-height: 100px; width: 75px; height: 100px" />
                          </div>

                          <!-- タイトル -->
                          <div class="col-md-5 d-flex flex-column justify-content-center p-3 border-end">
                            <small class="text-muted fw-semibold">タイトル</small>
                            <h4 class="fw-bold text-dark mt-2 title-clamp-2">${
                              book.title
                            }</h4>
                          </div>

                          <!-- 貸出日 -->
                          <div class="col-md-2 d-flex flex-column justify-content-center p-3 border-end">
                            <small class="text-muted text-center fw-semibold">貸出日</small>
                            <h6 class="fw-bold text-primary text-center mt-2 mb-0">${
                              log.loanDate
                            }</h6>
                          </div>

                          <!-- 返却日 -->
                          <div class="col-md-2 d-flex flex-column justify-content-center p-3 border-end">
                            <small class="text-muted text-center fw-semibold">返却日</small>
                            <h6 class="fw-bold text-center mt-2 mb-0">
                              <span class="returnInfo">
                                ${log.returnDate || "ー"}<br/>（${
                log.returnLocation
              }）
                              </span>
                            </h6>
                          </div>

                          <!-- 返却ボタン -->
                            ${
                              log.returnFlag
                                ? `<div class="col-md-1 d-flex flex-column justify-content-center p-3 border-end">
                                    <span class="btn btn-outline-success mt-2 mt-sm-0">
                                      返却済
                                    </span>
                                  </div>`
                                : `<div class="col-md-1 d-flex flex-column justify-content-center p-3 border-end">
                                    <span class="btn bg-primary return-button mt-2 mt-sm-0" data-bs-toggle="modal" data-bs-target="#returnModal">
                                      返却する
                                    </span>
                                  </div>`
                            }
                        </div>
                      </div>`;

              container.appendChild(card);

              const returnBtn = card.querySelector(".return-button");
              if (returnBtn) {
                returnBtn.addEventListener("click", function () {
                  document.querySelectorAll(".card").forEach((c) => {
                    c.removeAttribute("data-active");
                  });
                  card.setAttribute("data-active", "true");
                  card.setAttribute("data-book-id", book.id);
                  card.setAttribute("data-log-id", log.id);
                });
              }
            });
          })
          .catch((error) => {
            console.error("データの取得に失敗しました:", error);
          });
      });
    </script>

    <script>
      // ID：confirmReturnにクリックイベントを追加（確定ボタンを押したときの処理）
      document
        .getElementById("confirmReturn")
        .addEventListener("click", function () {
          // 選択したカードを特定
          const activeCard = document.querySelector(
            ".card[data-active='true']"
          );
          console.log(activeCard);
          if (!activeCard) return;

          // 今日の日付を取得
          const today = new Date();
          const formattedDate =
            today.getFullYear() +
            "/" +
            String(today.getMonth() + 1).padStart(2, "0") +
            "/" +
            String(today.getDate()).padStart(2, "0");

          // 返却日＋場所の表示を日付だけに置き換える
          const returnInfoEl = activeCard.querySelector(".returnInfo");

          // ユーザが入力した評価と難易度とコメントの取得
          const rating = document.getElementById("rating").value;
          const difficulty =
            document.querySelector('input[name="level"]:checked')?.value || "";
          const comment = document.getElementById("comment").value;
          const bookId = parseInt(activeCard.getAttribute("data-book-id"));
          const logId = parseInt(activeCard.getAttribute("data-log-id"));

          // 最後のレビューIDを取得して新しいIDを決定（仮にAPIがIDを自動生成しない場合）
          fetch("http://localhost:3000/reviews")
            .then((response) => response.json())
            .then((reviews) => {
              const maxId =
                reviews.length > 0 ? Math.max(...reviews.map((r) => r.id)) : 0;
              const newId = maxId + 1;
              const memberId = 7;

              // 新しいレビューオブジェクトを作成
              const newReview = {
                id: String(newId),
                memberId: parseInt(memberId),
                bookId: parseInt(bookId),
                stars: parseInt(rating),
                difficulty: parseInt(difficulty),
                comment: comment,
              };

              // POSTリクエストでレビューを追加（reviewsに新規データ追加）
              fetch("http://localhost:3000/reviews", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(newReview),
              })
                .then((res) => {
                  if (!res.ok) throw new Error("レビューの追加に失敗しました");
                  return res.json();
                })
                .then((data) => {
                  console.log("レビュー追加成功:", data);
                  fetch(`http://localhost:3000/logs/${logId}`, {
                    method: "PATCH",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      returnFlag: true,
                      returnDate: String(formattedDate),
                    }),
                  })
                    .then((res) => {
                      debugger;
                      if (!res.ok) throw new Error("ログの更新に失敗しました");
                      return res.json();
                    })
                    .then((updatedLog) => {
                      console.log("ログ更新成功:", updatedLog);
                      if (returnInfoEl) {
                        returnInfoEl.textContent = formattedDate;
                      }
                      const modal = bootstrap.Modal.getInstance(
                        document.getElementById("returnModal")
                      );
                      modal.hide();
                    })
                    .catch((error) => {
                      console.error("ログ更新エラー:", error);
                    });
                })
                .catch((error) => {
                  console.error("エラー:", error);
                });
            });
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
