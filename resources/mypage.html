<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>社内図書サービス</title>
    <!-- Bootstrap CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons-->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <link rel="stylesheet" href="/resources/style.css" />
  </head>
  <body>
    <!-- ナビバー -->
    <nav class="navbar sticky-top">
      <div
        class="container d-flex flex-wrap justify-content-between align-items-center"
        style="max-width: 1200px; margin: auto"
      >
        <!-- 左側：システム名 -->
        <div class="col-4 col-md-3">
          <a
            class="navbar-brand fw-bold text-white"
            href="/resources/toppage.html"
          >
            <i class="bi bi-star-fill text-warning"></i>NSLibrary<i
              class="bi bi-star-fill text-warning"
            ></i>
          </a>
        </div>
        <!-- 中央：検索フォーム（伸縮対応） -->
        <div class="col-12 col-md-6 position-relative px-2">
          <!-- 入力欄をdivに変更し、hidden inputを追加 -->
          <form
            class="d-flex search-form"
            role="search"
            action="/resources/booksearch.html"
          >
            <!-- バッジ表示領域と実際の入力欄を分ける -->
            <div
              id="badgeInput"
              class="form-control me-2 d-flex flex-wrap align-items-center"
              style="min-height: 38px; cursor: text"
              onclick="searchInput.focus()"
            >
              <!-- バッジがここに追加される -->
              <input
                id="searchInput"
                type="text"
                class="border-0 flex-grow-1"
                style="outline: none"
                placeholder="書籍名・著者名など"
              />
            </div>
            <input type="hidden" name="tags" id="hiddenTags" />
            <button class="btn btn-outline-light" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </form>

          <!-- タグボタン表示 -->
          <div
            id="tagContainer"
            class="bg-light border rounded p-3 mt-2 shadow-sm"
            style="display: none; position: absolute; width: 100%; z-index: 10"
          >
            <div class="mb-2 fw-bold">難易度</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                初心者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                中級者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                上級者向け
              </button>
            </div>

            <div class="mb-2 fw-bold">ジャンル</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                文学・評論
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                ビジネス
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                AWS
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                自己啓発
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                暮らし・健康
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                アート・デザイン
              </button>
            </div>

            <div class="mb-2 fw-bold">職種</div>
            <div class="d-flex flex-wrap gap-2">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                インフラ系
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                アプリ
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                コンサル
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                営業
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                マネジメント
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn-disabled"
              >
                データ
              </button>
            </div>
          </div>
        </div>
        <script>
          const tagContainer = document.getElementById("tagContainer");
          const badgeInput = document.getElementById("badgeInput");
          const hiddenTags = document.getElementById("hiddenTags");

          searchInput.addEventListener("focus", () => {
            tagContainer.style.display = "block";
          });

          document.addEventListener("click", (event) => {
            const isClickInside =
              badgeInput.contains(event.target) ||
              tagContainer.contains(event.target);
            if (!isClickInside) {
              tagContainer.style.display = "none";
            }
          });

          function addTagBadge(tag) {
            const existingTags = Array.from(
              badgeInput.querySelectorAll(".tag-badge")
            ).map((b) => b.dataset.tag);
            if (existingTags.includes(tag)) return;

            const badge = document.createElement("span");
            badge.className = "badge rounded-pill badge-outline me-1 tag-badge"; // Bootstrapのバッジクラス
            badge.dataset.tag = tag;
            badge.innerHTML = `${tag} <span class="ms-1 remove-btn" style="cursor:pointer;">&times;</span>`;

            badge.querySelector(".remove-btn").addEventListener("click", () => {
              event.stopPropagation();
              badge.remove();
              updateHiddenTags();
            });

            badgeInput.insertBefore(badge, searchInput); // 入力欄の左に追加
            updateHiddenTags();
          }

          function updateHiddenTags() {
            const tags = Array.from(
              badgeInput.querySelectorAll(".tag-badge")
            ).map((b) => b.dataset.tag);
            hiddenTags.value = tags.join(" ");
          }

          document.querySelectorAll(".tag-btn").forEach((button) => {
            button.addEventListener("click", () => {
              const tag = button.textContent.trim();
              addTagBadge(tag);
            });
          });
          searchInput.addEventListener("keydown", (event) => {
            if (
              event.key === "Backspace" &&
              searchInput.value === "" // 入力欄が空のとき
            ) {
              const tagBadges = badgeInput.querySelectorAll(".tag-badge");
              if (tagBadges.length > 0) {
                const lastBadge = tagBadges[tagBadges.length - 1];
                lastBadge.remove();
                updateHiddenTags();
              }
            }
          });
          document
            .querySelector(".search-form")
            .addEventListener("submit", (event) => {
              const tags = Array.from(
                badgeInput.querySelectorAll(".tag-badge")
              ).map((b) => b.dataset.tag);

              const form = event.target;

              // 条件分岐で action を変更
              if (tags.includes("初心者向け") && tags.includes("AWS")) {
                form.action = "/resources/booksearchEasyAWS.html";
              } else if (tags.includes("初心者向け")) {
                form.action = "/resources/booksearchEasy.html";
              } else {
                form.action = "/resources/booksearch.html"; // デフォルト
              }
            });
        </script>

        <!-- 右側：貸出履歴表示 -->
        <div class="d-flex align-items-center gap-1">
          <a
            href="/resources/booklog.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-book fs-5 text-white me-2"></i>
            <span class="text-white fw-light">貸出履歴</span>
          </a>
          <a
            href="/resources/mypage.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-person-circle fs-5 text-white me-2"></i>
            <span class="text-white fw-light">石倉 加菜子</span>
          </a>
        </div>
      </div>
    </nav>

    <!-- お気に入りゾーン -->
    <div
      id="favoritesZone"
      class="position-fixed bottom-0 end-0 p-3"
      style="width: 380px; max-height: 80vh; overflow-y: auto; z-index: 1050"
    >
      <div class="card shadow-sm" style="background-color: #fffafa">
        <!-- ヘッダー（クリックで開閉） -->
        <div
          id="favoritesHeader"
          class="card-header d-flex justify-content-between align-items-center px-3 py-2"
          style="
            background-color: #ffe4e1;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
          "
        >
          <span class="fw-semibold text-dark" style="font-size: 1.3rem">
            <i class="bi bi-heart-fill text-danger me-2"></i>お気に入り
          </span>
          <i id="favoritesToggleIcon" class="bi bi-chevron-down text-dark"></i>
        </div>
        <!-- コンテンツ（開閉対象） -->
        <div class="card-body p-2" id="favoritesList">
          <p class="text-muted small">まだ追加されていません。</p>
        </div>
      </div>
    </div>

    <div style="height: 30px"></div>

    <h1
      class="mb-4 text-center"
      style="margin-top: 50px; max-width: 1200px; margin: auto"
    >
      <i class="bi bi-person-lines-fill me-2"></i>登録情報
    </h1>

    <!--表にしてみた-->
    <div class="card shadow-sm">
      <div class="card-body">
        <table class="table table-bordered mb-0">
          <tbody>
            <tr style="height: 60px">
              <td
                style="
                  width: 30%;
                  font-weight: bold;
                  vertical-align: middle;
                  background-color: #f0f8ff;
                "
              >
                名前
              </td>
              <td style="vertical-align: middle" id="name">name</td>
            </tr>
            <tr style="height: 60px">
              <td
                style="
                  font-weight: bold;
                  vertical-align: middle;
                  background-color: #f0f8ff;
                "
              >
                部署
              </td>
              <td style="vertical-align: middle" id="department">department</td>
            </tr>
            <tr style="height: 60px">
              <td
                style="
                  font-weight: bold;
                  vertical-align: middle;
                  background-color: #f0f8ff;
                "
              >
                職種
              </td>
              <td style="vertical-align: middle" id="occupation">occupation</td>
            </tr>
            <tr style="height: 60px">
              <td
                style="
                  font-weight: bold;
                  vertical-align: middle;
                  background-color: #f0f8ff;
                "
              >
                役職
              </td>
              <td style="vertical-align: middle" id="position">position</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <h1
      id="reviewHeading"
      class="mt-3 mb-4 text-center"
      style="margin-top: 50px; max-width: 1200px; margin: auto"
    >
      <i class="bi bi-chat-left-text me-2"></i>過去のレビュー
    </h1>
    <!-- レビュー表示カード -->
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <!-- レビューリスト（ここにJSで追加される） -->
        <div id="reviewList" class="mt-3"></div>
      </div>
    </div>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // URLからidを取得
      const params = new URLSearchParams(window.location.search);
      const memberId = params.get("id");

      // データ取得
      fetch("/jsons/db.json")
        .then((response) => response.json())
        .then((data) => {
          const member = data.members.find((m) => m.id == memberId);
          if (!member) {
            alert("該当するユーザーが見つかりません");
            return;
          }

          // HTMLに反映
          document.getElementById("name").textContent = member.name;
          document.getElementById("department").textContent = member.department;
          document.getElementById("occupation").textContent = member.occupation;
          document.getElementById("position").textContent = member.position;

          document.getElementById(
            "reviewHeading"
          ).innerHTML = `<i class="bi bi-chat-left-text me-2"></i>${member.name}さんの過去のレビュー`;

          // レビュー抽出
          const reviews = data.reviews.filter((r) => r.memberId == memberId);
          const reviewList = document.getElementById("reviewList");

          if (reviews.length === 0) {
            reviewList.innerHTML =
              "<p class='text-muted'>レビューはまだありません。</p>";
            return;
          }

          reviews.forEach((review) => {
            const book = data.books.find((b) => b.id == review.bookId);
            if (!book) return; // 書籍情報が見つからない場合はスキップ

            const reviewCard = document.createElement("div");
            reviewCard.className = "d-flex mb-5";

            reviewCard.innerHTML = `
        <!-- 左：本の画像 -->
        <div class="me-3" style="width: 123px; flex-shrink: 0;">
          <img src="${book.image}" alt="${
              book.title
            }" class="img-fluid rounded shadow-sm" />
        </div>

        <!-- 右：レビュー内容 -->
        <div class="flex-grow-1">
          <h6 class="fw-bold mb-1">
          <a href="bookDetail.html?id=${book.id}"
                        class="review-link"
                      >
          ${book.title}
          </a></h6>

          <!-- 書籍全体の評価 -->
          <div class="mb-1 text-muted">
            評価：     <span class="text-warning">
            ${generateStarRating(book.stars)}
          </span>
      ${book.stars.toFixed(1)} (${book.reviews}件)
          </div>

          <!-- この人の評価（枠で囲む） -->
          <div class="border rounded p-3 bg-light">
            <div class="text-muted mb-1">${member.name}さんのレビュー</div>
            <div class="d-flex align-items-center justify-content-start mb-1">
              <div class="text-muted me-2">評価：</div>

          <span class="text-warning">
            ${generateStarRating(review.stars)}
          </span>


              <span class="me-2">${review.stars.toFixed(1)}</span>
            </div>
            <p class="mb-1 text-muted">${review.comment}</p>
          </div>
        </div>
      `;

            reviewList.appendChild(reviewCard);
          });
        });

      /**
       * 星評価のHTMLを生成する関数
       * @param {number} rating - 星評価（例: 4.5）
       * @returns {string} - 星評価のHTML
       */
      function generateStarRating(rating) {
        const fullStars = Math.floor(rating); // 整数部分
        const decimal = Math.round((rating % 1) * 10); // 小数点第一位（0〜9）

        let starsHtml = "";

        // 完全な星（整数部分）
        for (let i = 0; i < fullStars; i++) {
          starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
        }

        // 小数点の星（1つだけ追加、ただし最大5個まで）
        if (fullStars < 5) {
          if (decimal >= 0 && decimal <= 2) {
            starsHtml += '<i class="bi bi-star text-warning"></i>';
          } else if (decimal >= 3 && decimal <= 7) {
            starsHtml += '<i class="bi bi-star-half text-warning"></i>';
          } else if (decimal >= 8 && decimal <= 9) {
            starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
          }
        }

        // 残りの空白星（最大5個まで）
        const currentStars = starsHtml.match(/<i/g)?.length || 0;
        for (let i = currentStars; i < 5; i++) {
          starsHtml += '<i class="bi bi-star text-warning"></i>';
        }

        return starsHtml;
      }
    </script>
    <script>
      // お気に入りゾーン関連
      const favoritesKey = "favorites";
      let favorites = JSON.parse(localStorage.getItem(favoritesKey)) || [];

      function saveFavorites() {
        localStorage.setItem(favoritesKey, JSON.stringify(favorites));
      }

      function renderFavorites(bookData) {
        const favoritesList = document.getElementById("favoritesList");
        const favoriteBooks = bookData.filter((book) =>
          favorites.includes(book.id)
        );

        if (favoriteBooks.length === 0) {
          favoritesList.innerHTML = `<p class="text-muted small">まだ追加されていません。</p>`;
          return;
        }

        favoritesList.innerHTML = favoriteBooks
          .map(
            (book) => `
        <div class="d-flex align-items-center justify-content-between mb-4">
          <a href="bookDetail.html?id=${book.id}" class="text-decoration-none d-flex align-items-center">
            <img src="${book.image}" alt="${book.title}" style="width: 40px;" class="me-2 rounded shadow-sm" />
            <span class="favorite-title"" style="max-width: 160px;">${book.title}</span>
          </a>
          <button class="btn btn-sm btn-outline-secondary remove-favorite" data-id="${book.id}">
            削除
          </button>
        </div>
      `
          )
          .join("");
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetch("/jsons/db.json")
          .then((res) => res.json())
          .then((data) => {
            const bookData = data.books;
            renderFavorites(bookData);

            document.addEventListener("click", (e) => {
              const addBtn = e.target.closest(".favorite-btn");
              const removeBtn = e.target.closest(".remove-favorite");

              if (addBtn) {
                const bookId = addBtn.dataset.id;
                if (!favorites.includes(bookId)) {
                  favorites.push(bookId);
                  saveFavorites();
                  renderFavorites(bookData);
                  addBtn.innerHTML = `<i class="bi bi-x"></i> お気に入りから削除`;
                  addBtn.classList.remove("btn-outline-danger");
                  addBtn.classList.add(
                    "btn-outline-secondary",
                    "remove-favorite"
                  );
                }
              }

              if (removeBtn) {
                const bookId = removeBtn.dataset.id;
                favorites = favorites.filter((id) => id !== bookId);
                saveFavorites();
                renderFavorites(bookData);

                const originalBtn = document.querySelector(
                  `.favorite-btn[data-id="${bookId}"]`
                );
                if (originalBtn) {
                  originalBtn.innerHTML = `<i class="bi bi-heart"></i> お気に入りに追加`;
                  originalBtn.classList.remove(
                    "btn-outline-secondary",
                    "remove-favorite"
                  );
                  originalBtn.classList.add("btn-outline-danger");
                }
              }
            });
          });
      });
    </script>
    <script>
      const header = document.getElementById("favoritesHeader");
      const list = document.getElementById("favoritesList");
      const icon = document.getElementById("favoritesToggleIcon");

      let isOpen = true;

      header.addEventListener("click", () => {
        isOpen = !isOpen;
        list.style.display = isOpen ? "block" : "none";
        icon.className = isOpen
          ? "bi bi-chevron-down text-dark"
          : "bi bi-chevron-up text-dark";
      });
    </script>
  </body>
</html>
