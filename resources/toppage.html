<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>社内図書館システム</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Splide CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css"
    />
    <!-- Our CSS -->
    <link rel="stylesheet" href="/resources/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
  </head>
  <body>
    <nav class="navbar sticky-top">
      <div
        class="container d-flex flex-wrap justify-content-between align-items-center"
        style="max-width: 1200px; margin: auto"
      >
        <!-- 左側：システム名 -->
        <div class="col-4 col-md-3">
          <a
            class="navbar-brand fw-bold text-white"
            href="/resources/toppage.html"
          >
            <i class="bi bi-star-fill text-warning"></i>NSLibrary<i
              class="bi bi-star-fill text-warning"
            ></i>
          </a>
        </div>
        <!-- 中央：検索フォーム（伸縮対応） -->
        <div class="col-12 col-md-6 position-relative px-2">
          <!-- 入力欄をdivに変更し、hidden inputを追加 -->
          <form
            class="d-flex search-form"
            role="search"
            action="/resources/booksearch.html"
          >
            <!-- バッジ表示領域と実際の入力欄を分ける -->
            <div
              id="badgeInput"
              class="form-control me-2 d-flex flex-wrap align-items-center"
              style="min-height: 38px; cursor: text"
              onclick="searchInput.focus()"
            >
              <!-- バッジがここに追加される -->
              <input
                id="searchInput"
                type="text"
                class="border-0 flex-grow-1"
                style="outline: none"
                placeholder="書籍名・著者名など"
              />
            </div>
            <input type="hidden" name="tags" id="hiddenTags" />
            <button class="btn btn-outline-light" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </form>

          <!-- タグボタン表示 -->
          <div
            id="tagContainer"
            class="bg-light border rounded p-3 mt-2 shadow-sm"
            style="display: none; position: absolute; width: 100%; z-index: 10"
          >
            <div class="mb-2 fw-bold">難易度</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                初心者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                中級者向け
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                上級者向け
              </button>
            </div>

            <div class="mb-2 fw-bold">ジャンル</div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                文学・評論
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                ビジネス
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                AWS
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                自己啓発
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                暮らし・健康
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                アート・デザイン
              </button>
            </div>

            <div class="mb-2 fw-bold">職種</div>
            <div class="d-flex flex-wrap gap-2">
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                インフラ系
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                アプリ
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                コンサル
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                営業
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                マネジメント
              </button>
              <button
                type="button"
                class="btn badge-outline rounded-pill btn-sm tag-btn"
              >
                データ
              </button>
            </div>
          </div>
        </div>
        <script>
                const tagContainer = document.getElementById("tagContainer");
                const badgeInput = document.getElementById("badgeInput");
                const hiddenTags = document.getElementById("hiddenTags");

                searchInput.addEventListener("focus", () => {
                  tagContainer.style.display = "block";
                });

                document.addEventListener("click", (event) => {
                  const isClickInside =
                    badgeInput.contains(event.target) ||
                    tagContainer.contains(event.target);
                  if (!isClickInside) {
                    tagContainer.style.display = "none";
                  }
                });

                function updateHiddenTags() {
                  const tags = Array.from(
                    badgeInput.querySelectorAll(".tag-badge")
                  ).map((b) => b.dataset.tag);
                  hiddenTags.value = tags.join(" ");
                }

                function updateTagButtonStyles() {
                  const selectedTags = Array.from(
                    badgeInput.querySelectorAll(".tag-badge")
                  ).map((b) => b.dataset.tag);

                  document.querySelectorAll(".tag-btn").forEach((button) => {
                    const tag = button.textContent.trim();
                    if (selectedTags.includes(tag)) {
                      button.classList.add("tag-btn-selected");
                    } else {
                      button.classList.remove("tag-btn-selected");
                    }
                  });
                }

                function toggleTagBadge(tag) {
                  const existingBadge = Array.from(
                    badgeInput.querySelectorAll(".tag-badge")
                  ).find((b) => b.dataset.tag === tag);

                  if (existingBadge) {
                    existingBadge.remove();
                  } else {
                    const badge = document.createElement("span");
                    badge.className =
                      "badge rounded-pill badge-outline me-1 tag-badge";
                    badge.dataset.tag = tag;
                    badge.innerHTML = `${tag} <span class="ms-1 remove-btn" style="cursor:pointer;">&times;</span>`;

                    badge
                      .querySelector(".remove-btn")
                      .addEventListener("click", (event) => {
                        event.stopPropagation();
                        badge.remove();
                        updateHiddenTags();
                        updateTagButtonStyles();
                      });

                    badgeInput.insertBefore(badge, searchInput);
                  }

                  updateHiddenTags();
                  updateTagButtonStyles();
                }

                document.querySelectorAll(".tag-btn").forEach((button) => {
                  button.addEventListener("click", () => {
                    const tag = button.textContent.trim();
                    toggleTagBadge(tag);
                  });
                });
                searchInput.addEventListener("keydown", (event) => {
                  if (
                    event.key === "Backspace" &&
                    searchInput.value === "" // 入力欄が空のとき
                  ) {
                    const tagBadges = badgeInput.querySelectorAll(".tag-badge");
                    if (tagBadges.length > 0) {
                      const lastBadge = tagBadges[tagBadges.length - 1];
                      lastBadge.remove();
                      updateHiddenTags();
                      updateTagButtonStyles();
                    }
                  }
                });
                document
                  .querySelector(".search-form")
                  .addEventListener("submit", (event) => {
                    event.preventDefault(); // デフォルトの送信を防止
                    // タグ名とクエリパラメータのマッピング
                    const tagQueryMap = {
                      初心者向け: "1",
                      中級者向け: "2",
                      上級者向け: "3",
                      文学・評論: "4",
                      ビジネス: "5",
                      AWS: "6",
                      自己啓発: "7",
                      暮らし・健康: "8",
                      アート・デザイン: "9",
                      インフラ系: "10",
                      アプリ: "11",
                      コンサル: "12",
                      営業: "13",
                      マネジメント: "14",
                      データ: "15",
                      // 必要に応じて追加
                    };
                    // 選択されたタグを取得
          const selectedTags = Array.from(
            document.querySelectorAll(".tag-badge")
          ).map((badge) => badge.dataset.tag);

          // 対応するIDを取得
          const selectedIds = selectedTags
            .map((tag) => tagQueryMap[tag])
            .filter((id) => id !== undefined);

          // クエリパラメータを生成
          const queryString = selectedIds.length > 0 ? `?tags=${selectedIds.join(",")}` : "";

          // URLを設定して送信
          const form = event.target;
          const targetUrl = `/resources/booksearch.html${queryString}`;
          window.location.href = targetUrl;
                  });
        </script>

        <!-- 右側：貸出履歴表示 -->
        <div class="d-flex align-items-center gap-1">
          <a
            href="/resources/booklog.html"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-book fs-5 text-white me-2"></i>
            <span class="text-white fw-light">貸出履歴</span>
          </a>
          <a
            href="/resources/mypage.html?id=7"
            class="d-flex align-items-center text-decoration-none hover-outline rounded px-2"
          >
            <i class="bi bi-person-circle fs-5 text-white me-2"></i>
            <span class="text-white fw-light">石倉 加菜子</span>
          </a>
        </div>
      </div>
    </nav>

    <!-- お気に入りゾーン -->
    <div
      id="favoritesZone"
      class="position-fixed bottom-0 end-0 p-3"
      style="width: 380px; max-height: 80vh; overflow-y: auto; z-index: 1050"
    >
      <div class="card shadow-sm" style="background-color: #fffafa">
        <!-- ヘッダー（クリックで開閉） -->
        <div
          id="favoritesHeader"
          class="card-header d-flex justify-content-between align-items-center px-3 py-2"
          style="
            background-color: #ffe4e1;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
          "
        >
          <span class="fw-semibold text-dark" style="font-size: 1.3rem">
            <i class="bi bi-heart-fill text-danger me-2"></i>お気に入り
          </span>
          <i id="favoritesToggleIcon" class="bi bi-chevron-down text-dark"></i>
        </div>
        <!-- コンテンツ（開閉対象） -->
        <div class="card-body p-2" id="favoritesList">
          <p class="text-muted small">まだ追加されていません。</p>
        </div>
      </div>
    </div>

    <!-- レコメンド -->
    <div class="container-fluid my-5" style="max-width: 1200px">
      <div class="text-center mb-4 display-5 fw-bold">
        <i class="bi bi-book me-1"></i> おすすめ書籍
      </div>

      <nav class="container mb-4">
        <div class="d-flex flex-wrap justify-content-center gap-2">
          <span class="fs-5 fw-bold me-2">おすすめタグ：</span>
          <span class="badge rounded-pill badge-outline fs-6 me-1">AWS</span>
          <span class="badge rounded-pill badge-outline fs-6 me-1"
            >インフラ系</span
          ><span class="badge rounded-pill badge-outline fs-6 me-1"
            >初心者向け</span
          ><span class="badge rounded-pill badge-outline fs-6 me-1">アプリ</span
          ><span class="badge rounded-pill badge-outline fs-6 me-1"
            >データ</span
          >
        </div>
      </nav>
      <div id="splide-books" class="splide">
        <div
          class="splide__track"
          style="padding-top: 1rem; padding-bottom: 1rem"
        >
          <ul class="splide__list">
            <!-- JavaScriptで<li class="splide__slide">が追加されます -->
          </ul>
        </div>
      </div>
    </div>

    <br />

    <!-- 書籍イベントスライダー -->
    <div class="container-fluid my-4" style="max-width: 1200px">
      <!--  px-3 px-md-5 mt-5 mx-auto -->
      <div class="text-center mb-4 display-5 fw-bold">
        <i class="bi bi-calendar-event"></i> 書籍イベント
      </div>
      <div id="splide-event" class="splide">
        <div
          class="splide__track"
          style="padding-top: 1rem; padding-bottom: 1rem"
        >
          <ul class="splide__list">
            <li class="splide__slide">
              <div class="card p-0 mb-4 shadow-sm border-0">
                <img
                  src="/images/event1.png"
                  class="card-img-top"
                  alt="イベント画像"
                />
              </div>
            </li>
            <li class="splide__slide">
              <div class="card p-0 mb-4 shadow-sm border-0">
                <img
                  src="/images/event2.png"
                  class="card-img-top"
                  alt="イベント画像"
                />
              </div>
            </li>
            <li class="splide__slide">
              <div class="card p-0 mb-4 shadow-sm border-0">
                <img
                  src="/images/event3.png"
                  class="card-img-top"
                  alt="イベント画像"
                />
              </div>
            </li>
            <!-- 他のイベントも追加可能 -->
          </ul>
        </div>
      </div>
    </div>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Splide JS -->
    <script src="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/js/splide.min.js"></script>

    <script>
      new Splide("#splide-event", {
        type: "loop",
        perPage: 2,
        perMove: 1,
        gap: "1rem",
        focus: "center",
        breakpoints: {
          1024: { perPage: 2 },
          768: { perPage: 1 },
        },
      }).mount();
    </script>
    <script>
                document.addEventListener("DOMContentLoaded", function () {
                  const badges = document.querySelectorAll(".badge");

                  // タグ名とクエリパラメータのマッピング
                  const tagQueryMap = {
                    初心者向け: "1",
                    中級者向け: "2",
                    上級者向け: "3",
                    文学・評論: "4",
                    ビジネス: "5",
                    AWS: "6",
                    自己啓発: "7",
                    暮らし・健康: "8",
                    アート・デザイン: "9",
                    インフラ系: "10",
                    アプリ: "11",
                    コンサル: "12",
                    営業: "13",
                    マネジメント: "14",
                    データ: "15",
                    // 必要に応じて追加
                  };

                  badges.forEach(function (badge) {
                    const tag = badge.textContent.trim();
                    const queryValue = tagQueryMap[tag];

                    if (queryValue) {
                      badge.style.cursor = "pointer";
                      badge.addEventListener("click", function () {
                        window.location.href = `/resources/booksearch.html?tags=${queryValue}`;
                      });
                    }
                  });
                });
                // タグ名とクエリパラメータのマッピング
                 const tagQueryMap = {
                   初心者向け: "1",
                   中級者向け: "2",
                   上級者向け: "3",
                   文学・評論: "4",
                   ビジネス: "5",
                   AWS: "6",
                   自己啓発: "7",
                   暮らし・健康: "8",
                   アート・デザイン: "9",
                   インフラ系: "10",
                   アプリ: "11",
                   コンサル: "12",
                   営業: "13",
                   マネジメント: "14",
                   データ: "15",
                   // 必要に応じて追加
                 };
                     /**
                      * 星評価のHTMLを生成する関数
                      * @param {number} rating - 星評価（例: 4.5）
                      * @returns {string} - 星評価のHTML
                      */
                     function generateStarRating(rating) {
                       const fullStars = Math.floor(rating); // 整数部分
                       const decimal = Math.round((rating % 1) * 10); // 小数点第一位（0〜9）

                       let starsHtml = "";

                       // 完全な星（整数部分）
                       for (let i = 0; i < fullStars; i++) {
                         starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
                       }

                       // 小数点の星（1つだけ追加、ただし最大5個まで）
                       if (fullStars < 5) {
                         if (decimal >= 0 && decimal <= 2) {
                           starsHtml += '<i class="bi bi-star text-warning"></i>';
                         } else if (decimal >= 3 && decimal <= 7) {
                           starsHtml += '<i class="bi bi-star-half text-warning"></i>';
                         } else if (decimal >= 8 && decimal <= 9) {
                           starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
                         }
                       }

                       // 残りの空白星（最大5個まで）
                       const currentStars = starsHtml.match(/<i/g)?.length || 0;
                       for (let i = currentStars; i < 5; i++) {
                         starsHtml += '<i class="bi bi-star text-warning"></i>';
                       }

                       return starsHtml;
                     }

                     // 書籍データを取得してスライダーに表示
      Promise.all([
        fetch("http://localhost:3000/books").then((res) => res.json()),
        fetch("http://localhost:3000/categories").then((res) => res.json()),
      ]).then(([books, categories]) => {
        const categoryMap = {};
        categories.forEach((cat) => {
          categoryMap[cat.id] = cat.category;
        });

        const tagIds = [1, 6];
        const splideList = document.querySelector(".splide__list");
        splideList.innerHTML = "";

        const filteredBooks = books.filter((book) =>
          tagIds.every((tagId) => book.category.includes(tagId))
        );

        // レビュー取得をまとめて Promise 化
        const reviewPromises = filteredBooks.map((book) => {
          const reviewsEndpoint = `http://localhost:3000/reviews?bookId=${book.id}`;
          return fetch(reviewsEndpoint)
            .then((res) => res.json())
            .then((reviews) => {
              const count = reviews.length;
              const totalStars = reviews.reduce((sum, r) => sum + r.stars, 0);
              const avg = count > 0 ? (totalStars / count).toFixed(1) : "0.0";
              const starsHtml = generateStarRating(avg);

              const categoryBadges = (book.category || [])
                .map((catId) => {
                  const name = categoryMap[catId];
                  return name
                    ? `<span class="badge rounded-pill badge-outline me-1">${name}</span>`
                    : "";
                })
                .join("");

              const slide = `
                <li class="splide__slide">
                  <div class="card p-2 card-hover mb-4 shadow-sm border-0" style="min-height: 450px">
                    <a href="bookDetail.html?id=${book.id}" class="stretched-link"></a>
                    <div class="d-flex justify-content-center align-items-center bg-light" style="height: 280px">
                      <img src="${book.image}" class="img-fluid" style="width: 200px; height: 280px; object-fit: cover" alt="${book.title}" />
                    </div>
                    <div class="card-body d-flex flex-column justify-content-start p-3">
                      <h4 class="card-title mb-2 title-clamp-2">${book.title}</h4>
                      <div class="d-flex align-items-center gap-0 mb-1">
                        <span>
                          ${starsHtml}
                          <span class="text-muted small mx-1">${avg} (${count}件)</span>
                        </span>
                      </div>
                      <p class="card-text tag-group">${categoryBadges}</p>
                    </div>
                  </div>
                </li>
              `;

              splideList.insertAdjacentHTML("beforeend", slide);
            });
        });

        // すべてのレビュー取得が終わったら Splide を初期化
        Promise.all(reviewPromises).then(() => {
          new Splide("#splide-books", {
            type: "loop",
            rewind: true,
            perPage: 3,
            perMove: 1,
            start: 0,
            focus: 0,
            trimSpace: true,
            gap: "1rem",
            pagination: true,
            arrows: true,
            breakpoints: {
              1024: { perPage: 2 },
              768: { perPage: 1 },
            },
          }).mount();
        });
      });

                     // ★ イベント委任：親要素にクリックイベントをまとめて付与
                     document.addEventListener("click", function (e) {
                       if (e.target.classList.contains("badge")) {
                         const tag = e.target.textContent.trim();
                         const queryValue = tagQueryMap[tag];
                         if (queryValue) {
                           window.location.href = `/resources/booksearch.html?tags=${queryValue}`;
                         }
                       }
                     });
    </script>
    <script>
      // お気に入りゾーン関連
      const favoritesKey = "favorites";
      let favorites = JSON.parse(localStorage.getItem(favoritesKey)) || [];

      function saveFavorites() {
        localStorage.setItem(favoritesKey, JSON.stringify(favorites));
      }

      function renderFavorites(bookData) {
        const favoritesList = document.getElementById("favoritesList");
        const favoriteBooks = bookData.filter((book) =>
          favorites.includes(book.id)
        );

        if (favoriteBooks.length === 0) {
          favoritesList.innerHTML = `<p class="text-muted small">まだ追加されていません。</p>`;
          return;
        }

        favoritesList.innerHTML = favoriteBooks
          .map(
            (book) => `
        <div class="d-flex align-items-center justify-content-between mb-4">
          <a href="bookDetail.html?id=${book.id}" class="text-decoration-none d-flex align-items-center">
            <img src="${book.image}" alt="${book.title}" style="width: 40px;" class="me-2 rounded shadow-sm" />
            <span class="favorite-title"" style="max-width: 160px;">${book.title}</span>
          </a>
          <button class="btn btn-sm btn-outline-secondary remove-favorite" data-id="${book.id}">
            削除
          </button>
        </div>
      `
          )
          .join("");
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetch("/jsons/db.json")
          .then((res) => res.json())
          .then((data) => {
            const bookData = data.books;
            renderFavorites(bookData);

            document.addEventListener("click", (e) => {
              const addBtn = e.target.closest(".favorite-btn");
              const removeBtn = e.target.closest(".remove-favorite");

              if (addBtn) {
                const bookId = addBtn.dataset.id;
                if (!favorites.includes(bookId)) {
                  favorites.push(bookId);
                  saveFavorites();
                  renderFavorites(bookData);
                  addBtn.innerHTML = `<i class="bi bi-x"></i> お気に入りから削除`;
                  addBtn.classList.remove("btn-outline-danger");
                  addBtn.classList.add(
                    "btn-outline-secondary",
                    "remove-favorite"
                  );
                }
              }

              if (removeBtn) {
                const bookId = removeBtn.dataset.id;
                favorites = favorites.filter((id) => id !== bookId);
                saveFavorites();
                renderFavorites(bookData);

                const originalBtn = document.querySelector(
                  `.favorite-btn[data-id="${bookId}"]`
                );
                if (originalBtn) {
                  originalBtn.innerHTML = `<i class="bi bi-heart"></i> お気に入りに追加`;
                  originalBtn.classList.remove(
                    "btn-outline-secondary",
                    "remove-favorite"
                  );
                  originalBtn.classList.add("btn-outline-danger");
                }
              }
            });
          });
      });
    </script>
    <script>
      const header = document.getElementById("favoritesHeader");
      const list = document.getElementById("favoritesList");
      const icon = document.getElementById("favoritesToggleIcon");

      let isOpen = true;

      header.addEventListener("click", () => {
        isOpen = !isOpen;
        list.style.display = isOpen ? "block" : "none";
        icon.className = isOpen
          ? "bi bi-chevron-down text-dark"
          : "bi bi-chevron-up text-dark";
      });
    </script>
  </body>
</html>
